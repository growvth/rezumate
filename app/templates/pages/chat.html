{% extends "base.html" %}

{% block title %}Chat - Rezumate{% endblock %}

{% block content %}
<div id="setupCard" class="card chat-setup">
    <div class="chat-setup-header" onclick="toggleSetup()">
        <h1 class="card-title" style="margin-bottom:0">Resume Chat Setup</h1>
        <button type="button" class="chat-setup-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
            </svg>
        </button>
    </div>
    <div class="chat-setup-content">
        <div class="form-group">
            <label class="form-label" for="jobDescription">Job Description</label>
            <textarea
                id="jobDescription"
                class="form-textarea"
                placeholder="Paste the job description here..."
                style="min-height:80px"
            ></textarea>
        </div>

        <div class="form-group">
            <div id="uploadArea" class="upload-area" style="padding:1.5rem">
                <div class="upload-icon" style="width:40px;height:40px;margin-bottom:0.75rem">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:20px;height:20px">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                    </svg>
                </div>
                <p class="upload-title" style="font-size:0.9375rem">Upload your resume</p>
                <p class="upload-subtitle" style="font-size:0.8125rem;margin-bottom:0.75rem">PDF format</p>
                <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('resumeInput').click()">
                    Upload
                </button>
                <input type="file" id="resumeInput" class="upload-input" accept=".pdf,.doc,.docx" />
            </div>

            <div id="fileDisplay" class="file-display">
                <div class="file-info">
                    <div class="file-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                    </div>
                    <span id="fileName" class="file-name"></span>
                </div>
                <button type="button" class="file-remove" onclick="removeFile()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <button type="button" id="startChatBtn" class="btn btn-primary" onclick="startChat()" disabled>
            Start Chat
        </button>
    </div>
</div>

<div id="alertError" class="alert alert-error"></div>

<div id="chatCard" class="card" style="display:none">
    <div class="chat-container">
        <div id="chatMessages" class="chat-messages">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                    </svg>
                </div>
                <p>Ask questions about your resume</p>
            </div>
        </div>

        <div class="chat-input-container">
            <input
                type="text"
                id="chatInput"
                class="chat-input"
                placeholder="Ask about your resume..."
                onkeypress="if(event.key === 'Enter') sendMessage()"
            />
            <button type="button" id="sendBtn" class="btn btn-primary" onclick="sendMessage()">
                Send
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const setupCard = document.getElementById('setupCard');
    const chatCard = document.getElementById('chatCard');
    const uploadArea = document.getElementById('uploadArea');
    const fileDisplay = document.getElementById('fileDisplay');
    const fileNameSpan = document.getElementById('fileName');
    const resumeInput = document.getElementById('resumeInput');
    const startChatBtn = document.getElementById('startChatBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const alertError = document.getElementById('alertError');

    let selectedFile = null;
    let resumeText = '';
    let chatHistory = [];
    let isSetupCollapsed = false;

    const savedData = sessionStorage.getItem('resumeData');
    if (savedData) {
        try {
            const data = JSON.parse(savedData);
            if (data.text && data.jobDescription) {
                resumeText = data.text;
                document.getElementById('jobDescription').value = data.jobDescription;
                fileNameSpan.textContent = data.filename || 'Resume (from Score)';
                uploadArea.style.display = 'none';
                fileDisplay.classList.add('visible');
                startChatBtn.disabled = false;
            }
        } catch (e) {}
    }

    // Restore chat state from sessionStorage
    const savedChatState = sessionStorage.getItem('chatState');
    if (savedChatState) {
        try {
            const state = JSON.parse(savedChatState);
            if (state.chatStarted && state.chatHistory && resumeText) {
                chatHistory = state.chatHistory;
                setupCard.classList.add('collapsed');
                isSetupCollapsed = true;
                chatCard.style.display = 'block';

                // Restore chat messages
                const emptyState = chatMessages.querySelector('.empty-state');
                if (emptyState) emptyState.remove();

                chatHistory.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-message ${msg.role}`;
                    messageDiv.innerHTML = `<div class="chat-message-content">${formatMarkdown(msg.content)}</div>`;
                    chatMessages.appendChild(messageDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        } catch (e) {}
    }

    function toggleSetup() {
        isSetupCollapsed = !isSetupCollapsed;
        setupCard.classList.toggle('collapsed', isSetupCollapsed);
    }

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) handleFile(file);
    });

    resumeInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
    });

    function handleFile(file) {
        if (!file.name.match(/\.(pdf|doc|docx)$/i)) {
            showError('Please upload a PDF file');
            return;
        }
        selectedFile = file;
        resumeText = '';
        fileNameSpan.textContent = file.name;
        uploadArea.style.display = 'none';
        fileDisplay.classList.add('visible');
        startChatBtn.disabled = false;
        hideError();
    }

    function removeFile() {
        selectedFile = null;
        resumeText = '';
        resumeInput.value = '';
        uploadArea.style.display = 'block';
        fileDisplay.classList.remove('visible');
        startChatBtn.disabled = true;
        sessionStorage.removeItem('resumeData');
        sessionStorage.removeItem('chatState');
        chatHistory = [];
        chatCard.style.display = 'none';
        chatMessages.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                    </svg>
                </div>
                <p>Ask questions about your resume</p>
            </div>`;
        setupCard.classList.remove('collapsed');
        isSetupCollapsed = false;
    }

    function showError(message) {
        alertError.textContent = message;
        alertError.classList.add('visible');
    }

    function hideError() {
        alertError.classList.remove('visible');
    }

    async function startChat() {
        const jobDescription = document.getElementById('jobDescription').value.trim();
        if (!jobDescription) {
            showError('Please enter a job description');
            return;
        }

        if (selectedFile && !resumeText) {
            startChatBtn.disabled = true;
            startChatBtn.textContent = 'Processing...';

            const formData = new FormData();
            formData.append('job_description', jobDescription);
            formData.append('resume', selectedFile);

            try {
                const response = await fetch('/api/score', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to process resume');
                }

                resumeText = data.resume_text;
                sessionStorage.setItem('resumeData', JSON.stringify({
                    filename: selectedFile.name,
                    text: resumeText,
                    jobDescription: jobDescription
                }));

            } catch (error) {
                showError(error.message);
                startChatBtn.disabled = false;
                startChatBtn.textContent = 'Start Chat';
                return;
            }
        }

        setupCard.classList.add('collapsed');
        isSetupCollapsed = true;
        chatCard.style.display = 'block';
        chatInput.focus();
        startChatBtn.textContent = 'Start Chat';
        startChatBtn.disabled = false;

        saveChatState();
    }

    function saveChatState() {
        sessionStorage.setItem('chatState', JSON.stringify({
            chatStarted: true,
            chatHistory: chatHistory
        }));
    }

    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        const jobDescription = document.getElementById('jobDescription').value.trim();

        addMessage(message, 'user');
        chatInput.value = '';
        sendBtn.disabled = true;

        const formData = new FormData();
        formData.append('message', message);
        formData.append('job_description', jobDescription);
        formData.append('resume_text', resumeText);
        formData.append('chat_history', JSON.stringify(chatHistory));

        chatHistory.push({ role: 'user', content: message });

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || 'Failed to get response');
            }

            addMessage(data.response, 'assistant');
            chatHistory.push({ role: 'assistant', content: data.response });
            saveChatState();

        } catch (error) {
            addMessage('Sorry, something went wrong. Please try again.', 'assistant');
        } finally {
            sendBtn.disabled = false;
            chatInput.focus();
        }
    }

    function addMessage(content, role) {
        const emptyState = chatMessages.querySelector('.empty-state');
        if (emptyState) emptyState.remove();

        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}`;
        messageDiv.innerHTML = `<div class="chat-message-content">${formatMarkdown(content)}</div>`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatMarkdown(text) {
        return text
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/^- (.+)$/gm, '<li>$1</li>')
            .replace(/\n/g, '<br>');
    }
</script>
{% endblock %}
