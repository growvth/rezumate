{% extends "base.html" %}

{% block title %}Rank Resumes - Rezumate{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Rank Resumes</h1>

    <form id="rankForm">
        <div class="form-group">
            <label class="form-label" for="jobDescription">Job Description</label>
            <textarea
                id="jobDescription"
                name="job_description"
                class="form-textarea"
                placeholder="Paste the job description here..."
                required
            ></textarea>
        </div>

        <div class="form-group">
            <div id="uploadArea" class="upload-area">
                <div class="upload-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                    </svg>
                </div>
                <p class="upload-title">No resumes uploaded</p>
                <p class="upload-subtitle">Upload multiple resumes in PDF format</p>
                <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('resumesInput').click()">
                    Upload Resumes
                </button>
                <input type="file" id="resumesInput" class="upload-input" accept=".pdf,.doc,.docx" multiple />
            </div>

            <div id="fileList" class="file-list"></div>
        </div>

        <div id="alertError" class="alert alert-error"></div>

        <button type="submit" id="submitBtn" class="btn btn-primary" disabled>
            Rank Resumes
        </button>
    </form>
</div>

<div id="loadingCard" class="card loading">
    <div class="spinner"></div>
    <span class="loading-text">Ranking resumes...</span>
</div>

<div id="resultsCard" class="card results-card">
    <div class="results-header">
        <h2 class="results-title">Ranking Results</h2>
    </div>
    <div id="resultsContent" class="results-content"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const uploadArea = document.getElementById('uploadArea');
    const fileList = document.getElementById('fileList');
    const resumesInput = document.getElementById('resumesInput');
    const submitBtn = document.getElementById('submitBtn');
    const rankForm = document.getElementById('rankForm');
    const loadingCard = document.getElementById('loadingCard');
    const resultsCard = document.getElementById('resultsCard');
    const resultsContent = document.getElementById('resultsContent');
    const alertError = document.getElementById('alertError');

    let selectedFiles = [];

    // Restore state from sessionStorage
    const savedState = sessionStorage.getItem('rankState');
    if (savedState) {
        try {
            const state = JSON.parse(savedState);
            if (state.jobDescription) {
                document.getElementById('jobDescription').value = state.jobDescription;
            }
            if (state.result) {
                resultsContent.innerHTML = formatMarkdown(state.result);
                resultsCard.classList.add('visible');
            }
            if (state.fileNames && state.fileNames.length > 0) {
                uploadArea.style.display = 'none';
                fileList.innerHTML = state.fileNames.map((name, index) => `
                    <div class="file-list-item">
                        <span class="file-list-name">${name}</span>
                        <button type="button" class="file-remove" onclick="clearState()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:18px;height:18px">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `).join('');
            }
        } catch (e) {}
    }

    function clearState() {
        selectedFiles = [];
        sessionStorage.removeItem('rankState');
        uploadArea.style.display = 'block';
        fileList.innerHTML = '';
        resultsCard.classList.remove('visible');
        submitBtn.disabled = true;
    }
    window.clearState = clearState;

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });

    resumesInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
    });

    function handleFiles(files) {
        const validFiles = files.filter(f => f.name.match(/\.(pdf|doc|docx)$/i));
        if (validFiles.length !== files.length) {
            showError('Some files were skipped. Only PDF files are supported.');
        }

        validFiles.forEach(file => {
            if (!selectedFiles.find(f => f.name === file.name)) {
                selectedFiles.push(file);
            }
        });

        renderFileList();
        checkSubmitBtn();
        if (validFiles.length > 0) hideError();
    }

    function renderFileList() {
        if (selectedFiles.length === 0) {
            uploadArea.style.display = 'block';
            fileList.innerHTML = '';
            return;
        }

        uploadArea.style.display = 'none';
        fileList.innerHTML = selectedFiles.map((file, index) => `
            <div class="file-list-item">
                <span class="file-list-name">${file.name}</span>
                <button type="button" class="file-remove" onclick="removeFile(${index})">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width:18px;height:18px">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        `).join('') + `
            <button type="button" class="btn btn-secondary btn-sm" style="margin-top:0.5rem" onclick="document.getElementById('resumesInput').click()">
                Add More Resumes
            </button>
        `;
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        renderFileList();
        checkSubmitBtn();
        resultsCard.classList.remove('visible');
        sessionStorage.removeItem('rankState');
    }

    window.removeFile = removeFile;

    function checkSubmitBtn() {
        submitBtn.disabled = selectedFiles.length < 2;
    }

    function showError(message) {
        alertError.textContent = message;
        alertError.classList.add('visible');
    }

    function hideError() {
        alertError.classList.remove('visible');
    }

    rankForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();

        const jobDescription = document.getElementById('jobDescription').value.trim();
        if (!jobDescription) {
            showError('Please enter a job description');
            return;
        }

        if (selectedFiles.length < 2) {
            showError('Please upload at least 2 resumes');
            return;
        }

        const formData = new FormData();
        formData.append('job_description', jobDescription);
        selectedFiles.forEach(file => {
            formData.append('resumes', file);
        });

        submitBtn.disabled = true;
        loadingCard.classList.add('visible');
        resultsCard.classList.remove('visible');

        try {
            const response = await fetch('/api/rank', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || 'Failed to rank resumes');
            }

            resultsContent.innerHTML = formatMarkdown(data.result);
            resultsCard.classList.add('visible');

            // Save rank page state
            sessionStorage.setItem('rankState', JSON.stringify({
                jobDescription: jobDescription,
                fileNames: selectedFiles.map(f => f.name),
                result: data.result
            }));

        } catch (error) {
            showError(error.message);
        } finally {
            submitBtn.disabled = false;
            loadingCard.classList.remove('visible');
        }
    });

    function formatMarkdown(text) {
        return text
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            .replace(/^## (.+)$/gm, '<h2>$1</h2>')
            .replace(/^# (.+)$/gm, '<h1>$1</h1>')
            .replace(/^- (.+)$/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>')
            .replace(/^/, '<p>')
            .replace(/$/, '</p>')
            .replace(/<p><\/p>/g, '')
            .replace(/<p>(<h[1-3]>)/g, '$1')
            .replace(/(<\/h[1-3]>)<\/p>/g, '$1')
            .replace(/<p>(<ul>)/g, '$1')
            .replace(/(<\/ul>)<\/p>/g, '$1');
    }
</script>
{% endblock %}
