{% extends "base.html" %}

{% block title %}Compare Resumes - Rezumate{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Compare Resumes</h1>

    <form id="compareForm">
        <div class="form-group">
            <label class="form-label" for="jobDescription">Job Description</label>
            <textarea
                id="jobDescription"
                name="job_description"
                class="form-textarea"
                placeholder="Paste the job description here..."
                required
            ></textarea>
        </div>

        <div class="form-group">
            <div class="upload-grid">
                <div id="uploadBox1" class="upload-box" onclick="document.getElementById('resume1Input').click()">
                    <div class="upload-icon" style="margin: 0 auto 0.75rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                        </svg>
                    </div>
                    <p class="upload-box-title">Resume 1</p>
                    <p class="upload-box-subtitle">Upload a PDF file</p>
                    <button type="button" class="btn btn-primary btn-sm">Upload Resume</button>
                    <input type="file" id="resume1Input" class="upload-input" accept=".pdf,.doc,.docx" />
                </div>

                <div id="uploadBox2" class="upload-box" onclick="document.getElementById('resume2Input').click()">
                    <div class="upload-icon" style="margin: 0 auto 0.75rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                        </svg>
                    </div>
                    <p class="upload-box-title">Resume 2</p>
                    <p class="upload-box-subtitle">Upload a PDF file</p>
                    <button type="button" class="btn btn-primary btn-sm">Upload Resume</button>
                    <input type="file" id="resume2Input" class="upload-input" accept=".pdf,.doc,.docx" />
                </div>
            </div>
        </div>

        <div id="alertError" class="alert alert-error"></div>

        <button type="submit" id="submitBtn" class="btn btn-primary" disabled>
            Compare Resumes
        </button>
    </form>
</div>

<div id="loadingCard" class="card loading">
    <div class="spinner"></div>
    <span class="loading-text">Comparing resumes...</span>
</div>

<div id="resultsCard" class="card results-card">
    <div class="results-header">
        <h2 class="results-title">Comparison Results</h2>
    </div>
    <div id="resultsContent" class="results-content"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const uploadBox1 = document.getElementById('uploadBox1');
    const uploadBox2 = document.getElementById('uploadBox2');
    const resume1Input = document.getElementById('resume1Input');
    const resume2Input = document.getElementById('resume2Input');
    const submitBtn = document.getElementById('submitBtn');
    const compareForm = document.getElementById('compareForm');
    const loadingCard = document.getElementById('loadingCard');
    const resultsCard = document.getElementById('resultsCard');
    const resultsContent = document.getElementById('resultsContent');
    const alertError = document.getElementById('alertError');

    let file1 = null;
    let file2 = null;

    function setupUploadBox(box, input, setFile, fileNum) {
        box.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            box.classList.add('dragover');
        });

        box.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            box.classList.remove('dragover');
        });

        box.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            box.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file, box, setFile, fileNum);
        });

        input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file, box, setFile, fileNum);
        });
    }

    function handleFile(file, box, setFile, fileNum) {
        if (!file.name.match(/\.(pdf|doc|docx)$/i)) {
            showError('Please upload a PDF file');
            return;
        }
        setFile(file);
        box.classList.add('has-file');
        box.innerHTML = `
            <div class="file-icon" style="margin: 0 auto 0.75rem;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
            </div>
            <p class="upload-box-title">${file.name}</p>
            <p class="upload-box-subtitle">Resume ${fileNum}</p>
            <button type="button" class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); removeFile${fileNum}()">Remove</button>
        `;
        checkSubmitBtn();
        hideError();
    }

    function removeFile1() {
        file1 = null;
        resume1Input.value = '';
        uploadBox1.classList.remove('has-file');
        uploadBox1.innerHTML = `
            <div class="upload-icon" style="margin: 0 auto 0.75rem;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
            </div>
            <p class="upload-box-title">Resume 1</p>
            <p class="upload-box-subtitle">Upload a PDF file</p>
            <button type="button" class="btn btn-primary btn-sm">Upload Resume</button>
        `;
        checkSubmitBtn();
    }

    function removeFile2() {
        file2 = null;
        resume2Input.value = '';
        uploadBox2.classList.remove('has-file');
        uploadBox2.innerHTML = `
            <div class="upload-icon" style="margin: 0 auto 0.75rem;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
            </div>
            <p class="upload-box-title">Resume 2</p>
            <p class="upload-box-subtitle">Upload a PDF file</p>
            <button type="button" class="btn btn-primary btn-sm">Upload Resume</button>
        `;
        checkSubmitBtn();
    }

    window.removeFile1 = removeFile1;
    window.removeFile2 = removeFile2;

    setupUploadBox(uploadBox1, resume1Input, (f) => { file1 = f; }, 1);
    setupUploadBox(uploadBox2, resume2Input, (f) => { file2 = f; }, 2);

    function checkSubmitBtn() {
        submitBtn.disabled = !(file1 && file2);
    }

    function showError(message) {
        alertError.textContent = message;
        alertError.classList.add('visible');
    }

    function hideError() {
        alertError.classList.remove('visible');
    }

    compareForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();

        const jobDescription = document.getElementById('jobDescription').value.trim();
        if (!jobDescription) {
            showError('Please enter a job description');
            return;
        }

        if (!file1 || !file2) {
            showError('Please upload both resumes');
            return;
        }

        const formData = new FormData();
        formData.append('job_description', jobDescription);
        formData.append('resume1', file1);
        formData.append('resume2', file2);

        submitBtn.disabled = true;
        loadingCard.classList.add('visible');
        resultsCard.classList.remove('visible');

        try {
            const response = await fetch('/api/compare', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || 'Failed to compare resumes');
            }

            resultsContent.innerHTML = formatMarkdown(data.result);
            resultsCard.classList.add('visible');

        } catch (error) {
            showError(error.message);
        } finally {
            submitBtn.disabled = false;
            loadingCard.classList.remove('visible');
        }
    });

    function formatMarkdown(text) {
        return text
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            .replace(/^## (.+)$/gm, '<h2>$1</h2>')
            .replace(/^# (.+)$/gm, '<h1>$1</h1>')
            .replace(/^- (.+)$/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>')
            .replace(/^/, '<p>')
            .replace(/$/, '</p>')
            .replace(/<p><\/p>/g, '')
            .replace(/<p>(<h[1-3]>)/g, '$1')
            .replace(/(<\/h[1-3]>)<\/p>/g, '$1')
            .replace(/<p>(<ul>)/g, '$1')
            .replace(/(<\/ul>)<\/p>/g, '$1');
    }
</script>
{% endblock %}
